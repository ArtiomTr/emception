<!doctype html><html><head><meta charset="utf-8"><title>Emception</title><meta name="viewport" content="width=device-width,initial-scale=1">
</head>
<body>

<h1>Emception</h1>
<p>Emception is a web-based C++ compiler and runtime environment.</p>
<p>It uses <a href="https://emscripten.org/">Emscripten</a> to compile C++ code to WebAssembly and runs it in a sandboxed environment.</p>
<p>It is a work in progress and not ready for production use.</p>
<p>Try it out by entering some C++ code below and clicking the "Compile" button.</p>
<button id="compile">Compile</button>
<textarea id="cpp" style="width: 100%; height: 200px;">
#include<iostream>
#include<string>
using namespace std;
int main(){
  string name;
  cin >> name;
  cout << "Hello " << name << "!" << endl;
  return 0;
}
</textarea>
<textarea id="stdout" style="width: 100%; height: 100px;"> </textarea>
<textarea id="stdin" style="width: 47%; height: 100px; display: inline-block; padding: 1%">input test</textarea>
<textarea id="expected" style="width: 47%; height: 100px; display: inline-block; padding: 1% "> </textarea>

<script>
    // intercept stdin
    window.prompt = function() {
      return document.getElementById("stdin").value;
    }
    
    var stdoutElement = document.getElementById("stdout");
    var stdinElement = document.getElementById("stdin");
    var expectedElement = document.getElementById("expected");
    var cppElement = document.getElementById("cpp");

    // prejs
    // todo: improve and make it not search for the element every time
    const prejs = `
var Module = {
    print: (function() {
        var element = stdoutElement;
        if (element) element.value = ''; // clear browser cache
        return function(text) {
            if (arguments.length > 1) text = Array.prototype.slice.call(arguments).join(' ');
            // todo: do replacements needed
            console.log(text);
            if (element) {
                element.value += text + "";
                element.scrollTop = element.scrollHeight; // focus on bottom
            }
        };
    })(),
    printErr: function(text) {
        if (arguments.length > 1) text = Array.prototype.slice.call(arguments).join(' ');
        if (0) { // XXX disabled for safety typeof dump == 'function') {
            dump(text + '\\n'); // fast, straight to the real console
        } else {
            console.error(text);
        }

        var element = stdoutElement;
        if (element) {
            element.value += text + "";
            element.scrollTop = element.scrollHeight; // focus on bottom
        }
    }
};
    `;

    const onprocessstart = (argv) => {
        console.log("onprocessstart", argv);
        // stdoutElement.value += '# ' + argv.join(' ') + "\n";
    };
    const onprocessend = () => {
        console.log("onprocessend");
        // document.getElementById("stdout").value += "onprocessend" + "\n";
    };
    const onstdout = (str) => {
        console.log(str);
        stdoutElement.value += str + "\n";
        stdoutElement.scrollTop = stdoutElement.scrollHeight; // focus on bottom
    };
    const onstderr = (str) =>{
        console.error(str);
        stdoutElement.value += str + "\n";
        stdoutElement.scrollTop = stdoutElement.scrollHeight; // focus on bottom
    };

    const EmceptionState = {
        MainNotLoaded:0,
        MainLoading:1,
        MainLoaded:2,
        EmceptionLoading:3,
        EmceptionLoaded:4,
    }
    var loadingState = EmceptionState.MainNotLoaded;
    var emception;

    // todo: bug: this state machine is not running for the second time
    async function preCompile(){
        onstdout("preCompile: " + loadingState);
        switch (loadingState) {
            case EmceptionState.MainNotLoaded:
                loadingState = EmceptionState.MainLoading;
                var script = document.createElement('script');
                script.src = 'main.js';
                script.onload = ()=>{
                    onstdout("main.js loaded");
                    loadingState = EmceptionState.MainLoaded;
                    preCompile();
                }
                document.head.appendChild(script);
                return false;
            case EmceptionState.MainLoading:
                onstdout("Main script is still loading. Please wait.");
                return false
            case EmceptionState.MainLoaded:
                onstdout("initializing Emception...");
                loadingState = EmceptionState.EmceptionLoading;
                emception = new Emception.default();
                emception.onstdout = onstdout;
                emception.onstderr = onstderr;
                emception.onprocessstart = onprocessstart;
                emception.onprocessend = onprocessend;
                await emception.init();
                loadingState = EmceptionState.EmceptionLoaded;
                onstdout("Emception initialized");
                preCompile();
                return false;
            case EmceptionState.EmceptionLoading:
                onstdout("Emception is still loading. Please wait.");
                return false;
            case EmceptionState.EmceptionLoaded:
                await compile();
                return true;
        }
    }

    window.onerror = function(event) {
        // TODO: do not warn on ok events like simulating an infinite loop or exitStatus
        // Module.setStatus('Exception thrown, see JavaScript console');
        //Module.setStatus = function(text) {
        if (text) console.error('[post-exception status] ' + text);
        //};
    };

    async function compile(){
        stdoutElement.value = "";
        const cppValue = cppElement.value;

        console.log("Compiling C++ code...\n");
        try {
            await emception.fileSystem.writeFile("/working/main.cpp", cppValue);
            await emception.fileSystem.writeFile("/working/pre.js", prejs);
            // todo: add prejs to emscripten command --pre-js pre.js
            const cmd = `em++ -O2 -fexceptions --pre-js pre.js -sEXIT_RUNTIME=1 -sSINGLE_FILE=1 -sUSE_CLOSURE_COMPILER=0 main.cpp -o main.js`;
            onprocessstart(`/emscripten/${cmd}`.split(/\s+/g));
            onstdout(`# ${cmd}`);
            // wait 100ms
            await new Promise(resolve => setTimeout(resolve, 100));
            const result = await emception.run(cmd);
            if (result.returncode == 0) {
                const content = new TextDecoder().decode(await emception.fileSystem.readFile("/working/main.js"));
                onstdout(`# node ./main.js`);
                eval(content);
            } else {
                console.log(`Emception compilation failed`);
            }
        } catch (err) {
            console.error(err);
        } finally {
            // add your finally code here
        }
    }

    document.getElementById("compile").addEventListener("click", async function() {
        await preCompile();
    });
</script>
</body></html>